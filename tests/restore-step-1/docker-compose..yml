name: postgres-test-restore
services:

  s3mock:
    image: adobe/s3mock:latest
    container_name: s3mock-restore
    environment:
      - COM_ADOBE_TESTING_S3MOCK_STORE_INITIAL_BUCKETS=bucket1
      - COM_ADOBE_TESTING_S3MOCK_STORE_RETAIN_FILES_ON_EXIT=true
      - COM_ADOBE_TESTING_S3MOCK_STORE_ROOT=containers3root
      - debug=true
    volumes:
      - ../s3/data:/containers3root
    ports:
      - 9090:9090
    networks:
      - pg_restore_network

  primary-postgres-backup:
    container_name: test-restore-backup
    depends_on:
      - s3mock
    restart: no
    build:
      context: ../../pg-backup
    env_file:
      - ../var.env
    environment:
      - PG_BACKUP_STORAGE_S3_ENDPOINT=http://s3mock-restore:9090
      - PGDATA=/var/pgdata
    entrypoint: ["/sbin/tini", "--", "npm", "run", "restore"]
    volumes:
      - ../pgdata-restore:/var/pg-restore
    networks:
      - pg_restore_network

networks:
  pg_restore_network:
    driver: bridge
