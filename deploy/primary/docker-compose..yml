name: postgres-primary
services:

  certbot:
    container_name: pg-cert-bot
    image: ghcr.io/social-mail/pg-ssl:latest 
    restart: always
    env_file:
      - ../var.env
    volumes:
      - ../certs:/etc/letsencrypt
    ports:
      - "80:80"
    networks:
      - pg_network

  postgres:
    container_name: primary-postgres
    image: ghcr.io/social-mail/postgres-ha:latest
    restart: always
    env_file:
      - ../var.env
    # environment: # Uncomment this to restore from backup
    #   - PG_RESTORE=/var/pg-restore
    volumes:
      - ../wal:/db/wal
      - db-socket:/var/run/postgresql
      - ../pgdata:/var/pgdata
      - ../certs:/etc/letsencrypt
    #  - ../pgdata-restore:/var/pg-restore
    depends_on:
      - certbot
    ports:
      - 5432:5432
    networks:
      - pg_network

  primary-postgres-backup:
    container_name: primary-postgres-backup
    restart: always
    image: ghcr.io/social-mail/pg-backup:latest
    environment:
      - PG_BACKUP_STORAGE_S3_BACKUP_FOLDER=pg-1
    depends_on:
      - postgres
    volumes:
      - db-socket:/var/run/postgresql
      - ../backups:/cache
    env_file:
      - ../var.env
    networks:
      - pg_network


volumes:
  db-socket:
    external: false

networks:
  pg_network:
    driver: bridge
